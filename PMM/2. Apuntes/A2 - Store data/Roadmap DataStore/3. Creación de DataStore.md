
> En este punto aprender√°s c√≥mo crear **Preferences DataStore** en Android para almacenar configuraciones de usuario de manera segura y eficiente.

---

## **3.1 Usar `preferencesDataStore` para definir el archivo de almacenamiento**

> Jetpack DataStore usa **un archivo interno** en la memoria de la aplicaci√≥n para guardar datos.

Para definir este archivo, la mejor pr√°ctica es usar **una extensi√≥n de `Context` con `preferencesDataStore`**, ya que esta forma evita problemas de m√∫ltiples instancias.

### **Ejemplo recomendado:**

> Si la app es peque√±a, puedes definirlo directamente en `SettingsDataStore.kt`

> Si no, debe colocarse en **un archivo Kotlin separado**, generalmente en un **singleton** o en un archivo de utilidades (`Utils`).
> 
> üìå **Ubicaci√≥n recomendada:**  `com.tuapp.data.DataStoreModule.kt`

```kotlin
private val Context.dataStore by preferencesDataStore(name = "settings")
```

#### üìå **Explicaci√≥n:**

- `dataStore` es una **propiedad de extensi√≥n de `Context`**.
- `preferencesDataStore(name = "settings")` crea un archivo de almacenamiento llamado **"settings.preferences_pb"** en el directorio interno de la app.
- **Cada vez que accedas a `dataStore`, se usar√° la misma instancia autom√°ticamente**.

#### üîπ **¬øD√≥nde se guarda este archivo?**  

El archivo de DataStore se almacena en:  

```Android
/data/data/com.tuapp/datastore/settings.preferences_pb
```

---

## **3.2 Diferencias entre `Context.dataStore` y una instancia manual de DataStore**

Hay **dos formas** de inicializar DataStore en una app.

#### **‚úÖ Opci√≥n recomendada: Usar `preferencesDataStore` en `Context` (Extensi√≥n de propiedad)**

```kotlin
private val Context.dataStore by preferencesDataStore(name = "settings")
```

‚úî **Ventajas:**

- **Autom√°tico**: Solo se crea una √∫nica instancia, evitando problemas de corrupci√≥n de datos.
- **F√°cil de usar**: No necesitas preocuparte por manejar manualmente la instancia.
- **Segura en multihilo**: Jetpack DataStore maneja la concurrencia internamente.

#### **üö´ Opci√≥n NO recomendada: Crear DataStore manualmente con `DataStoreFactory`**

Se puede crear una instancia manual usando `DataStoreFactory`, pero **esto no es recomendable**, ya que puede generar m√∫ltiples instancias en la app si no se maneja correctamente.

```kotlin
val dataStore: DataStore<Preferences> = DataStoreFactory.create(
    produceFile = { File(context.filesDir, "settings.preferences_pb") }
)
```

---

## **Ejemplo completo de creaci√≥n de DataStore en Android**

### **1Ô∏è‚É£ Definir DataStore en el `Context` (Extensi√≥n de propiedad)**

```kotlin
private val Context.dataStore by preferencesDataStore(name = "settings")
```

### **2Ô∏è‚É£ Crear una clase para manejar DataStore (Repositorio)**

```kotlin
class SettingsDataStore(private val context: Context) {
    
    companion object {
        private val THEME_KEY = booleanPreferencesKey("dark_mode")
    }

    // Guardar preferencia
    suspend fun saveThemePreference(isDarkMode: Boolean) {
        context.dataStore.edit { preferences ->
            preferences[THEME_KEY] = isDarkMode
        }
    }

    // Leer preferencia como Flow
    val themeFlow: Flow<Boolean?> = context.dataStore.data.map { preferences ->
        preferences[THEME_KEY]
    }
}
```

### **3Ô∏è‚É£ Acceder a DataStore desde una `Activity` o `ViewModel`**

```kotlin
class MainViewModel(private val settingsDataStore: SettingsDataStore) : ViewModel() {

    val isDarkMode: LiveData<Boolean?> = settingsDataStore.themeFlow.asLiveData()

    fun toggleDarkMode(enabled: Boolean) {
        viewModelScope.launch {
            settingsDataStore.saveThemePreference(enabled)
        }
    }
}
```

---

### **Resumen y mejores pr√°cticas**

‚úÖ Usa **`preferencesDataStore` en `Context`** para evitar m√∫ltiples instancias.  
‚úÖ Define un **repositorio** (`SettingsDataStore`) para encapsular la l√≥gica de acceso a datos.  
‚úÖ **No uses `DataStoreFactory.create()` manualmente**, ya que puede causar corrupci√≥n de datos.  
‚úÖ Accede a DataStore en **ViewModel** usando `LiveData` y `Flow`.
